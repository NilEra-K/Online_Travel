<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>查询页面</title>
    <!-- <meta name="renderer" content="webkit"> -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../css/public.css" media="all">
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <style>
        html,
        body,
        #container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 5px;">
            <legend>查询图表功能</legend>
        </fieldset>
        <form class="layui-form layui-form-pane" action="">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">日期选择</label>
                    <div class="layui-input-block">
                        <input type="text" name="date" id="date1" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">范围</label>
                    <div class="layui-input-inline" style="width: 150px;">
                        <input type="text" name="fromTime" id="fromtime1" placeholder="FROM hh:mm:ss" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid"> ~ </div>
                    <div class="layui-input-inline" style="width: 150px;">
                        <input type="text" name="toTime" id="totime1" placeholder="TO hh:mm:ss" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">表格名称</label>
                <div class="layui-input-block">
                    <select name="tableName" lay-filter="showTable">
                        <option value=""></option>
                        <option value="0" selected=""></option>
                        <option value="1">热力图</option>
                        <option value="2">人流量柱状图</option>
                        <option value="3">人流量趋势图</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="container"></div>
<div id="heatmap-input-card" style="display: none;">
    <div class="input-card" style="width: auto;">
        <div class="input-item">
            <button class="btn" id="show-btn">显示热力图</button>
        </div>
        <div class="input-item">
            <button class="btn" id="hide-btn">关闭热力图</button>
        </div>
    </div>    
</div>

<div id="scenicMinuteSelected" style="width: 1500px; height: 700px;"></div>

<script src="https://webapi.amap.com/maps?v=2.0&key=18f5957b88c867af639c550a85fe9429"></script>
<script src="https://a.amap.com/jsapi_demos/static/resource/heatmapData.js"></script>
<script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script src="../lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script>
    layui.use(['form', 'layedit', 'laydate', 'echarts'], function () {
        var form = layui.form
            , layer = layui.layer
            , echarts = layui.echarts
            , layedit = layui.layedit
            , laydate = layui.laydate;

        //日期
        laydate.render({ elem: '#date' });
        laydate.render({ elem: '#date1' });

        //创建一个编辑器
        var editIndex = layedit.build('LAY_demo_editor');

        //自定义验证规则
        form.verify({
            title: function (value) {
                if (value.length < 5) {
                    return '标题至少得5个字符啊';
                }
            }
            , pass: [
                /^[\S]{6,12}$/
                , '密码必须6到12位，且不能出现空格'
            ]
            , content: function (value) {
                layedit.sync(editIndex);
            }
        });

        //监听指定开关
        form.on('switch(switchTest)', function (data) {
            layer.msg('开关checked：' + (this.checked ? 'true' : 'false'), {
                offset: '6px'
            });
            layer.tips('温馨提示：请注意开关状态的文字可以随意定义，而不仅仅是ON|OFF', data.othis)
        });

        //监听提交
        form.on('submit(demo1)', function (data) {
            // layer.alert(JSON.stringify(data.field), {
            //     title: '最终的提交信息'
            // })
            // 获取表单数据
            var formData = data.field;

            // 发送数据到后端
            $.ajax({
                type: "POST",
                url: "http://localhost:9090/travelserver/scenic/selectForm", // 后端接收数据的URL
                contentType: "application/json",    // 设置请求内容类型为JSON
                data: JSON.stringify(formData),     // 发送的表单数据
                success: function(response) {
                    // 请求成功时的处理
                    console.log("数据发送成功");
                    console.log(formData);
                    console.log(response);          // 可以根据后端返回的数据进行处理
                    // console.log(formData["tableName"]);
                    if (formData["tableName"]=="1") {
                        // 开始执行
                        console.log("开始执行创建热力图")
                        document.getElementById("scenicMinuteSelected").style.display = "none";
                        var showHeatmapBtn = document.getElementById("heatmap-input-card");
                        showHeatmapBtn.style.display = "block";
                        let heatData = Object.values(response)
                        var map = new AMap.Map("container", {
                            resizeEnable: true,
                            center: [117.016089, 36.661138],        // 替换热力图中心
                            zoom: 15                                // 设置区域大小
                        });

                        if (!isSupportCanvas()) {
                            alert('热力图仅对支持canvas的浏览器适用,您所使用的浏览器不能使用热力图功能,请换个浏览器试试~')
                        }

                        var heatmap;
                        map.plugin(["AMap.HeatMap"], function () {
                            if (heatmap == null) {
                                //初始化heatmap对象
                                heatmap = new AMap.HeatMap(map, {
                                    radius: 50, //给定半径
                                    opacity: [0, 0.8]
                                    /*,
                                    gradient:{
                                        0.5: 'blue',
                                        0.65: 'rgb(117,211,248)',
                                        0.7: 'rgb(0, 255, 0)',
                                        0.9: '#ffea00',
                                        1.0: 'red'
                                    }
                                    */
                                });
                                console.log(heatData);
                                heatmap.setDataSet({
                                    data: heatData,      // 需要替换为自己的数据
                                    max: 100
                                });
                            }
                        });
                        //判断浏览区是否支持canvas
                        function isSupportCanvas() {
                            var elem = document.createElement('canvas');
                            return !!(elem.getContext && elem.getContext('2d'));
                        }

                        function showHeatmap() {
                            heatmap.show()
                        }

                        function hideHeatmap() {
                            heatmap.hide()
                        }

                        document.getElementById('show-btn').addEventListener('click', showHeatmap);
                        document.getElementById('hide-btn').addEventListener('click', hideHeatmap);
                    }
                    if (formData["tableName"]=="2") {
                        // console.log(latestScenicMinuteData)
                        console.log("开始执行创建人流量柱状图")
                        let latestScenicMinuteData = Object.values(response)
                        var echartsScenicMinuteSelected = echarts.init(document.getElementById('scenicMinuteSelected'), 'walden');
                        var xData = new Array()     // 数量
                        var yData = new Array()     // 景点
                        var latestTime = latestScenicMinuteData[0].time;
                        var formattedTime = `${latestTime.slice(0, 4)}年 ${latestTime.slice(4, 6)}月 ${latestTime.slice(6, 8)}日 ${latestTime.slice(8, 10)} : ${latestTime.slice(10, 12)}`;
                        for (var i = 0; i < latestScenicMinuteData.length; i++) {
                            xData.push(latestScenicMinuteData[i].count)
                            yData.push(latestScenicMinuteData[i].scenic)
                        }
                        var option = {
                            title: {
                                text: '最新济南各景点人流量',
                                subtext: '截至' + formattedTime,
                            },
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: {
                                    type: 'shadow'
                                }
                            },
                            legend: {},
                            toolbox: { // 添加工具箱
                                show: true,
                                feature: {
                                    dataView: { show: true, readOnly: false },  // 数据视图
                                    saveAsImage: { show: true }                 // 保存为图片
                                }
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'value',
                                boundaryGap: [0, 0.01]
                            },
                            yAxis: {
                                type: 'category',
                                interval: 'auto', // 自动间隔显示标签
                                data: yData
                            },
                            series: [
                                {
                                    name: '人流量',
                                    type: 'bar',
                                    data: xData
                                }
                            ]
                        };
                        echartsScenicMinuteSelected.setOption(option);
                    }
                },
                error: function(xhr, status, error) {
                    // 请求失败时的处理
                    console.error("数据发送失败");
                    console.log(formData)
                    console.error(error);
                }
            });
            return false;
        });

        // 获取重置按钮元素
        var resetButton = document.querySelector('.layui-btn-primary');

        // 添加点击事件监听器
        resetButton.addEventListener('click', function(event) {
            // 在这里添加重置按钮点击后的逻辑操作
            console.log('重置按钮被点击了');
            var showHeatmapBtn = document.getElementById("heatmap-input-card");
            var heatmapContainer = document.getElementById("container");            
            showHeatmapBtn.style.display = "none";
            heatmapContainer.style.display = "none";
        });

        //表单初始赋值
        form.val('example', {
            "username": "贤心" // "name": "value"
            , "password": "123456"
            , "interest": 1
            , "like[write]": true //复选框选中状态
            , "close": true //开关状态
            , "sex": "女"
            , "desc": "我爱 layui"
        })
    });
</script>

</body>
</html>